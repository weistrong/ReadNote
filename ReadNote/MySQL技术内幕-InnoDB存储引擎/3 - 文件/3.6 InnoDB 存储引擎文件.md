## InnoDB存储引擎文件

> 除了 MySQL 数据库自身的文件，每个表存储引擎还有其自身独有的文件。
>
> 这些文件包括**重做日志文件**、**表空间文件**。



#### 表空间文件

> InnoDB 采用将存储的数据按表空间_(tablespace)_ 进行存放的设计。

* 默认表空间
  * 初始大小为 10MB，名为 ibdata1。
  * 可以通过参数 `innodb_data_file_path` 对其进行设置。
    * 设置后，所有基于 InnoDB存储引擎的表的数据都会记录到该共享表空间中。
    * 如果设置了 `innodb_file_pre_table`，则是使用独立表空间。

![InnoDB存储引擎：2、文件和表- 知乎](../MySQL.assets/InnoDB存储引擎：2、文件和表- 知乎.jpeg)

#### 重做日志文件

> 它们记录了对于 InnoDB存储引擎的事务日志。
>
> 默认情况下，在 InnoDB存储引擎的数据目录下会有两个名为 ib_logfile 和 ib_logfile1 的文件。在 MySQL 官方手册中将其称为 InnoDB存储引擎的日志文件，不过更准确的定义应该是重做日志文件_(redo log file)_。
>
> 每个 InnoDB存储引擎至少有 1 个重做日志文件组_(group)_，每个文件组至少有 2 个重做日志文件。

* **下列参数影响着重做日志文件的属性：**

  * `innodb_log_file_size`
    * 指定每个重做日志文件的大小。
    * InnoDB 1.2.x 之前，重做日志文件总大小不能大于等于 4GB，之后该限制扩大到了 512GB。
  * `innodb_log_file_in_group`
    * 指定了日志文件组中重做日志文件的数量，默认是 2.
  * `innodb_mirrored_log_groups`
    * 指定了日志镜像文件组的数量，默认是 1，表示只有一个日志文件组，没有镜像。
  * `innodb_log_group_home_dir`
    * 指定了日志文件组所在路径，默认为 `./`，表示在 MySQL 数据库的数据目录下。

* **对性能的影响：**

  * 重做日志文件的大小设置对于 InnoDB存储引擎的性能有着非常大的影响。
  * 如果设置的太大，可能恢复需要很长的时间。
  * 如果设置的太小，可能导致一个事务的日志需要多次切换重做日志文件。此外，会导致频繁地发生 async checkpoint，导致性能的抖动。

* **和二进制日志的区别：**

  * 二进制日志会记录所有与 MySQL数据库有关的日志记录，包括其它引擎的日志。而 InnoDB存储引擎的重做日志只记录有关该存储引擎本身的事务日志。
  * 记录的内容不同：
    * 无论将二进制日志文件记录的格式设置成什么，二进制日志记录的都是关于一个事务的具体操作内容，即该日志是逻辑日志。
    * 重做日志文件记录的是关于每个页_(page)_ 的更改的物理情况。
  * 写入的时间不同：
    * 二进制日志仅在事务提交前进行提交，只写磁盘一次，不论这时事务多大。
    * 在事务进行的过程中，不断有重做日志条目_(redo entry)_ 被写入到重做日志文件中。

* **重做日志条目的结构：**

  * `redo_log_type`:
    * 占用 1 字节，表示重做日志的类型。
  * `space`
    * 表空间 ID，但采用压缩的方式，因此占用的空间可能小于 4 字节。
  * `page_no`
    * 页的偏移量，同样采用压缩的方式。
  * `redo_log_body`
    * 每个重做日志的数据部分，恢复时需要调用相应的函数进行解析。

  | redo_log_type | space | page_no | redo_log_body |
  | ------------- | ----- | ------- | ------------- |
  |               |       |         |               |

* **重做日志的写入过程：**

  * 写入重做日志的操作不是直接写，而是先写入一个重做日志缓存_(redo log buffer)_ 中，然后按照一定的条件顺序地写入日志文件中。
  * 从重做日志缓冲往磁盘写入时，是按 512 个字节_(一个扇区的大小)_.

![3.6.2 重做日志文件](../MySQL.assets/3.6.2 重做日志文件.png)