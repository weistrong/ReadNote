## 委托

> Microsoft .Net Framework 通过委托来提供回调函数机制。委托确保回调函数是类型安全的。还允许顺序调用多个方法，并支持调用静态方法和实例方法。

* 委托对象是方法的包装器_(warpper)_。

* 在一个类型中通过委托来调用另一个类型的私有成员，只要委托对象是由足够安全/可访问性的代码创建的，便没有问题。

* 将方法绑定到委托时，C#和CLR都允许引用类型的 `协变性` 和 `逆变性`。

  * 只有**引用类型**才支持，值类型和void都不支持。
  * **协变性_(covariance)_**
    * 方法能返回从委托的返回类型派生的一个类型。
  * **逆变性_(contravariance)_**
    * 方法获取的参数可以是委托的参数类型的基类。

  ```C#
  delegate Object MyCallback(FileStream stream);
  // 允许
  String Method(Stream stream);
  // 不允许
  Int32 Method(Stream stream);
  ```

#### 委托揭秘

* 所有委托类型都派生自 `System.MulticastDelegate` ，后者由派生自 `System.Delegate` ，最后是 `System.Object`。

  * 由于委托类型都派生自 `MulticastDelegate` ，所以继承了它的所有字段、属性和方法。其中有三个非公共字段尤为重要：

    |      字段       |     类型      | 说明                                                         |
    | :-------------: | :-----------: | :----------------------------------------------------------- |
    |     _target     | System.Object | 当委托对象包装一个静态方法时，这个字段为null，当委托对象包装一个实例方法时，这个字段引用的时回调方法要操作的对象。换言之，这个字段值指出要传给实例方法的饮食参数this的值。 |
    |   _methodPtr    | System.IntPtr | 一个内部的整数值，CLR用它标识要回调的方法。                  |
    | _invocationList | System.Object | 通常为null。构造委托链时它引用一个委托数组。                 |

    